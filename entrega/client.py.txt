# cliente TCP interativo do MiniCoin (repl)
# conecta ao servidor, envia comandos e mostra respostas em json
# toda logica de validacao e blockchain fica no servidor
# autores: Joao Meyer e Vitor Faria

import socket
import argparse

def recvline(sock):
    # le uma linha completa vinda do servidor
    data = bytearray()
    while True:
        ch = sock.recv(1)
        if not ch:
            return None
        if ch == b'\n':
            break
        data += ch
    return data.decode('utf-8', errors='replace')

def main():
    # argumentos de execucao (host e porta)
    ap = argparse.ArgumentParser(description="MiniCoin TCP Client (REPL)")
    ap.add_argument("--host", default="127.0.0.1")
    ap.add_argument("--port", type=int, default=9090)
    args = ap.parse_args()

    # conecta ao servidor tcp
    with socket.create_connection((args.host, args.port)) as sock:
        hello = recvline(sock)
        if hello is not None:
            print(hello)

        # loop principal do repl
        while True:
            try:
                line = input("minicoin> ")
            except (EOFError, KeyboardInterrupt):
                print()
                line = "QUIT"

            if not line.strip():
                continue

            try:
                # envia comando ao servidor
                sock.sendall((line.strip() + "\n").encode('utf-8'))
            except BrokenPipeError:
                print("conexao encerrada pelo servidor.")
                break

            # le resposta em json (1 linha)
            resp = recvline(sock)
            if resp is None:
                print("servidor fechou a conexao.")
                break

            print(resp)

            # encerra se o usuario digitar quit ou exit
            if line.strip().upper() in ("QUIT", "EXIT"):
                break

if __name__ == "__main__":
    main()
