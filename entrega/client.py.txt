#   MiniCoin - Cliente TCP Interativo (REPL)
#   Objetivo: permitir que o usuário envie comandos ao servidor MiniCoin por meio de
#             uma conexão TCP persistente, exibindo as respostas em JSON retornadas
#             pelo servidor. Não requer bibliotecas externas.
#   Restrições/escopo: o cliente apenas envia texto e recebe respostas linha-a-linha;
#             não há interpretação interna da lógica de blockchain — toda validação
#             e persistência ocorrem no servidor.
#
#   Autores: João Meyer e Vitor Faria
#   Disciplina: Redes II
#
# Comandos no prompt:
#   HELP
#   INIT <owner> <initial>
#   DEPOSIT <owner> <amount>
#   WITHDRAW <owner> <amount>
#   BALANCE <owner>
#   CHAIN <owner>
#   VERIFY <owner>
#   TRANSFER <owner_from> <owner_to> <amount>
#   ACCOUNTS
#   QUIT

import socket
import argparse

def recvline(sock):
    data = bytearray()
    while True:
        ch = sock.recv(1)
        if not ch:
            return None
        if ch == b'\n':
            break
        data += ch
    return data.decode('utf-8', errors='replace')

def main():
    ap = argparse.ArgumentParser(description="MiniCoin TCP Client (REPL)")
    ap.add_argument("--host", default="127.0.0.1")
    ap.add_argument("--port", type=int, default=9090)
    args = ap.parse_args()

    with socket.create_connection((args.host, args.port)) as sock:
        hello = recvline(sock)
        if hello is not None:
            print(hello)
        while True:
            try:
                line = input("minicoin> ")
            except (EOFError, KeyboardInterrupt):
                print()
                line = "QUIT"
            if not line.strip():
                continue
            try:
                sock.sendall((line.strip() + "\n").encode('utf-8'))
            except BrokenPipeError:
                print("Conexão encerrada pelo servidor.")
                break
            resp = recvline(sock)
            if resp is None:
                print("Servidor fechou a conexão.")
                break
            print(resp)
            if line.strip().upper() in ("QUIT", "EXIT"):
                break

if __name__ == "__main__":
    main()